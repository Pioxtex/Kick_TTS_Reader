<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kick TTS Reader by Pioxtex</title>
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; margin: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    label { display:block; margin: 6px 0 4px; font-weight: 600; }
    input[type=text], select, input[type=number], input[type=range] { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #bbb; }
    .row { display:flex; gap:12px; align-items: center; flex-wrap: wrap; }
    .row > div { flex:1; min-width: 220px; }
    button { padding: 10px 16px; border-radius: 10px; border: 0; background: #2b8a3e; color: #fff; font-weight: 700; cursor: pointer; }
    button.secondary { background: #6c757d; }
    button.warn { background: #c92a2a; }
    button.ghost { background: #495057; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .log { height: 320px; overflow:auto; background: #0e0f14; color:#d1d1d1; padding: 10px; border-radius: 8px; font-family: Consolas, monospace; }
    .muted { color:#999; }
    .warn { color:#ffbf00; }
    .error { color:#ff6b6b; }
    .rangewrap { display:flex; align-items:center; gap:8px; }
    .rangewrap input[type=number] { max-width: 90px; }
    .kbd { font-family: Consolas, monospace; background:#222; color:#eee; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h2>Kick TTS Reader by Pioxtex</h2>
  <div id="preloadWarn" class="warn" style="display:none;">⚠️ Preload nie dziala - sprawdz w Console czy widac „[preload.cjs] loaded".</div>
  <div class="card">
    <label>Nazwa kanalu na Kick (bez https://kick.com/):</label>
    <input id="channel" type="text" placeholder="np. pioxtex" />
    <div class="row" style="margin-top:10px;">
      <div>
        <label>Limit dlugosci (znaki)</label>
        <input id="maxlen" type="number" value="220" min="40" max="500">
      </div>
      <div>
        <label>Tempo mowy (0.5 - 2.0)</label>
        <input id="rate" type="number" value="0.75" min="0.5" max="2" step="0.1">
      </div>
      <div>
        <label>Glosnosc (0-100)</label>
        <div class="rangewrap">
          <input id="volume" type="range" min="0" max="100" value="100">
          <input id="volumeNum" type="number" min="0" max="100" value="100">
        </div>
      </div>
      <div>
        <label>Czytaj komendy (!...)?</label>
        <select id="readCommands"><option value="false" selected>Nie</option><option value="true">Tak</option></select>
      </div>
      <div>
        <label>Filtr wulgaryzmow</label>
        <select id="profanity"><option value="true" selected>Wlaczony</option><option value="false">Wylaczony</option></select>
      </div>
      <div>
        <label>Ignoruj boty (Streamlabs/Nightbot...)</label>
        <select id="skipBots"><option value="true" selected>Tak</option><option value="false">Nie</option></select>
      </div>
      <div>
        <label>Dzielenie na frazy</label>
        <select id="chunking"><option value="true">Wlaczone</option><option value="false">Wylaczone</option></select>
      </div>
      <div>
        <label>Max kolejka (1-200)</label>
        <input id="maxQueue" type="number" value="60" min="1" max="200">
      </div>
      <div>
        <label>Prefix TTS</label>
        <input id="prefix" type="text" value="{user} ">
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <button id="startBtn">Start</button>
      <button id="stopBtn" class="secondary" disabled>Stop</button>
      <button id="muteBtn" class="ghost" disabled>Mute (M)</button>
      <button id="skipBtn" class="warn" disabled>Skip (K)</button>
      <span id="state" class="muted" style="margin-left:10px;">Idle</span>
    </div>
    <div class="muted" style="margin-top:6px;">Skroty: <span class="kbd">M</span> - Mute/Unmute, <span class="kbd">K</span> - Skip biezacej.</div>
  </div>

  <div class="card">
    <div class="log" id="log"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const logEl = $('log');
    const stateEl = $('state');
    const startBtn = $('startBtn');
    const stopBtn = $('stopBtn');
    const muteBtn = $('muteBtn');
    const skipBtn = $('skipBtn');
    const preloadWarn = $('preloadWarn');
    const vol = $('volume');
    const volNum = $('volumeNum');
    let muted = false;

    vol.addEventListener('input', () => volNum.value = vol.value);
    volNum.addEventListener('input', () => { 
      let v = parseInt(volNum.value || '0', 10);
      if (isNaN(v)) v = 0; v = Math.max(0, Math.min(100, v));
      volNum.value = v; vol.value = v;
    });

    function log(text, cls) {
      const line = document.createElement('div');
      if (cls) line.className = cls;
      line.textContent = text;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(text);
    }

    function sanitizeChannel(input) {
      try {
        if (input.includes('http')) {
          const u = new URL(input);
          const parts = u.pathname.split('/').filter(Boolean);
          return parts[0] || input;
        }
      } catch {}
      if (input.includes('kick.com/')) {
        const parts = input.split('kick.com/')[1].split('/').filter(Boolean);
        return parts[0] || input;
      }
      return input.replace(/\s+/g, '').replace(/^@/, '');
    }

    function setControlsEnabled(en) {
      muteBtn.disabled = !en;
      skipBtn.disabled = !en;
    }

    if (!window.kicktts || !window.kicktts.start) {
      preloadWarn.style.display = 'block';
      log('Preload API niedostepne - Start zablokowany.', 'error');
      startBtn.disabled = true;
    } else {
      window.kicktts.onLog((t) => log(t));
      window.kicktts.onState((s) => { stateEl.textContent = s; });
      window.kicktts.onMuted((m) => { muted = m; muteBtn.textContent = m ? 'Unmute (M)' : 'Mute (M)'; });
    }

    startBtn?.addEventListener('click', async () => {
      try {
        let channel = $('channel').value.trim();
        if (!channel) { alert('Podaj nazwe kanalu.'); return; }
        channel = sanitizeChannel(channel);
        log('[init] Kanal: ' + channel);
        startBtn.disabled = true; stopBtn.disabled = false; setControlsEnabled(true);
        const options = {
          maxLen: parseInt($('maxlen').value || '220', 10),
          rate: parseFloat($('rate').value || '0.75'),
          volume: parseInt(vol.value || '100', 10),
          chunking: document.getElementById('chunking').value === 'true',
          maxQueue: parseInt(document.getElementById('maxQueue').value || '60', 10),
          readCommands: document.getElementById('readCommands').value === 'true',
          profanity: document.getElementById('profanity').value === 'true',
          skipBots: document.getElementById('skipBots').value === 'true',
          prefix: document.getElementById('prefix').value || '{user} '
        };
        await window.kicktts.start(channel, options);
        log('▶️ Start dla kanalu: ' + channel);
      } catch (e) {
        log('Blad Start: ' + (e?.message || e), 'error');
        startBtn.disabled = false; stopBtn.disabled = true; setControlsEnabled(false);
      }
    });

    stopBtn?.addEventListener('click', async () => {
      try {
        await window.kicktts.stop();
        log('⏹️ Stop');
      } catch (e) {
        log('Blad Stop: ' + (e?.message || e), 'error');
      } finally {
        startBtn.disabled = false; stopBtn.disabled = true; setControlsEnabled(false);
      }
    });

    muteBtn?.addEventListener('click', async () => {
      const m = await window.kicktts.toggleMute();
      muted = m; muteBtn.textContent = m ? 'Unmute (M)' : 'Mute (M)';
    });

    skipBtn?.addEventListener('click', async () => {
      await window.kicktts.skip();
    });

    window.addEventListener('keydown', async (e) => {
      if (e.key === 'm' || e.key === 'M') {
        const m = await window.kicktts.toggleMute();
        muted = m; muteBtn.textContent = m ? 'Unmute (M)' : 'Mute (M)';
      } else if (e.key === 'k' || e.key === 'K') {
        await window.kicktts.skip();
      }
    });
  </script>
</body>
</html>
